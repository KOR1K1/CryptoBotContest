# WebSocket Update Throttling

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

**BidUpdateThrottlerService** –¥–ª—è –±–∞—Ç—á–∏–Ω–≥–∞ WebSocket –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∏ —Å–Ω–∏–∂–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏ –≤—ã—Å–æ–∫–∏—Ö —á–∞—Å—Ç–æ—Ç–∞—Ö —Å—Ç–∞–≤–æ–∫ (100k+ bids/round).

---

## üéØ –ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ?

### –ü—Ä–æ–±–ª–µ–º–∞ –±–µ–∑ throttling:
- –ü—Ä–∏ 10,000 —Å—Ç–∞–≤–æ–∫/—Å–µ–∫: **10,000 WebSocket emits/—Å–µ–∫** = –æ–≥—Ä–æ–º–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ CPU, network, –∫–ª–∏–µ–Ω—Ç—ã
- –ö–∞–∂–¥–∞—è —Å—Ç–∞–≤–∫–∞ –≤—ã–∑—ã–≤–∞–µ—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π emit ‚Üí –∫–ª–∏–µ–Ω—Ç—ã –ø–æ–ª—É—á–∞—é—Ç —Ç—ã—Å—è—á–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
- –ë—Ä–∞—É–∑–µ—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ —É—Å–ø–µ–≤–∞—é—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –≤—Å–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- –°–µ—Ä–≤–µ—Ä —Ç—Ä–∞—Ç–∏—Ç CPU –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö/–ø–æ—Ö–æ–∂–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

### –†–µ—à–µ–Ω–∏–µ —Å throttling:
- **–ë–∞—Ç—á–∏–Ω–≥**: –ù–∞–∫–∞–ø–ª–∏–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –≤ –ø–∞–º—è—Ç–∏ –∫–∞–∂–¥—ã–µ 100ms
- **Significance check**: –≠–º–∏—Ç —Ç–æ–ª—å–∫–æ –∑–Ω–∞—á–∏–º—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π (—Ç–æ–ø-10 –ø–æ–∑–∏—Ü–∏–π)
- **–ê–≥—Ä–µ–≥–∞—Ü–∏—è**: –û–¥–∏–Ω emit —Å aggregated –¥–∞–Ω–Ω—ã–º–∏ –≤–º–µ—Å—Ç–æ —Ç—ã—Å—è—á–∏ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö emits
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –°–Ω–∏–∂–µ–Ω–∏–µ WebSocket —Ç—Ä–∞—Ñ–∏–∫–∞ –Ω–∞ 70-90%, —Å–Ω–∏–∂–µ–Ω–∏–µ CPU –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ 60-80%

---

## üìã –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### 1. BidUpdateThrottlerService

**–§–∞–π–ª**: `src/services/throttler/bid-update-throttler.service.ts`

**–û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞**:
```typescript
// Pending updates per auction
private readonly pendingBidUpdates = new Map<string, Set<any>>();

// Last known top-10 positions (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–Ω–∞—á–∏–º–æ—Å—Ç–∏)
private readonly lastTopPositions = new Map<string, { amounts: number[]; lastUpdate: Date }>();

// Flush timer (–∫–∞–∂–¥—ã–µ 100ms)
private readonly BATCH_INTERVAL_MS = 100;
```

**–ú–µ—Ç–æ–¥—ã**:
- `queueBidUpdate(auctionId, bid)`: –î–æ–±–∞–≤–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ –æ—á–µ—Ä–µ–¥—å
- `flushPendingUpdates()`: –§–ª–∞—à–∏—Ç—å –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–∫–∞–∂–¥—ã–µ 100ms)
- `checkSignificance(auctionId, updates)`: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–Ω–∞—á–∏–º–æ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–π
- `forceFlush(auctionId)`: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π flush (–¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π)

### 2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å AuctionsGateway

**–§–∞–π–ª**: `src/gateways/auctions.gateway.ts`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
```typescript
emitBidUpdate(auctionId: string, bid: any) {
  // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å throttler –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
  if (this.bidUpdateThrottler) {
    this.bidUpdateThrottler.queueBidUpdate(auctionId, bid);
  } else {
    // Fallback: immediate emit
    this.server.to(`auction:${auctionId}`).emit('bid_update', {...});
  }
}

emitBidUpdateImmediate(auctionId: string, data: any) {
  // Bypass throttler (–¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π)
  this.server.to(`auction:${auctionId}`).emit('bid_update', {...});
}
```

**Circular Dependency —Ä–µ—à–µ–Ω–∏–µ**:
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω `forwardRef()` –¥–ª—è –∏–Ω–∂–µ–∫—Ü–∏–∏ `AuctionsGateway` –≤ `ThrottlerService`
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω `forwardRef()` –¥–ª—è –∏–Ω–∂–µ–∫—Ü–∏–∏ `ThrottlerService` –≤ `AuctionsGateway`
- –ú–æ–¥—É–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã —á–µ—Ä–µ–∑ `forwardRef(() => ThrottlerModule)`

### 3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å RoundSchedulerService

**–§–∞–π–ª**: `src/services/scheduler/round-scheduler.service.ts`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
```typescript
// –ü–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º —Ä–∞—É–Ω–¥–∞ - force flush –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
if (this.bidUpdateThrottler) {
  await this.bidUpdateThrottler.forceFlush(auctionId);
}

// –ó–∞—Ç–µ–º emit –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π (round_closed, auction_update)
this.auctionsGateway.emitRoundClosed(...);
```

### 4. –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã

**–§–∞–π–ª**: `src/controllers/auctions/auctions.controller.ts`

**–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π**: –ò—Å–ø–æ–ª—å–∑—É—é—Ç `auctionsGateway.emitBidUpdate()` –∫–∞–∫ —Ä–∞–Ω—å—à–µ, –Ω–æ —Ç–µ–ø–µ—Ä—å —ç—Ç–æ throttled –º–µ—Ç–æ–¥.

---

## üîç –õ–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–Ω–∞—á–∏–º–æ—Å—Ç–∏

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –∑–Ω–∞—á–∏–º–æ—Å—Ç–∏:
1. **–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ç–æ–ø-10 –ø–æ–∑–∏—Ü–∏—è—Ö**:
   - –†–∞–∑–º–µ—Ä —Ç–æ–ø-10 –∏–∑–º–µ–Ω–∏–ª—Å—è (winners count –∏–∑–º–µ–Ω–∏–ª—Å—è)
   - Amounts –≤ —Ç–æ–ø-10 –∏–∑–º–µ–Ω–∏–ª–∏—Å—å (–ø–æ–∑–∏—Ü–∏–∏ –ø–æ–º–µ–Ω—è–ª–∏—Å—å)

2. **–í—Ö–æ–¥ –≤ —Ç–æ–ø-10**:
   - –ù–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞ —Å `amount >= minimum –≤ —Ç–µ–∫—É—â–µ–º top-10`
   - –ù–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞ —Å `amount >= minimum –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–º –∏–∑–≤–µ—Å—Ç–Ω–æ–º top-10`

3. **–ü–µ—Ä–≤—ã–π emit**:
   - –ü–µ—Ä–≤—ã–π —Ä–∞–∑ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∞—É–∫—Ü–∏–æ–Ω ‚Üí emit –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ baseline

### –ê–ª–≥–æ—Ä–∏—Ç–º:
```typescript
async checkSignificance(auctionId: string, updates: any[]): Promise<boolean> {
  // 1. –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π top-10
  const currentTopBids = await this.bidService.getTopActiveBids(auctionId, 10);
  const currentTopAmounts = currentTopBids.map(b => b.amount).sort((a, b) => b - a);
  const minTopAmount = currentTopAmounts[currentTopAmounts.length - 1] || 0;

  // 2. –°—Ä–∞–≤–Ω–∏—Ç—å —Å –ø–æ—Å–ª–µ–¥–Ω–∏–º –∏–∑–≤–µ—Å—Ç–Ω—ã–º top-10
  const lastKnown = this.lastTopPositions.get(auctionId);
  
  // 3. –ï—Å–ª–∏ —Ä–∞–∑–º–µ—Ä –∏–ª–∏ amounts –∏–∑–º–µ–Ω–∏–ª–∏—Å—å ‚Üí –∑–Ω–∞—á–∏–º–æ
  if (!lastKnown || currentTopAmounts.length !== lastKnown.amounts.length) {
    return true;
  }

  // 4. –ï—Å–ª–∏ amounts –≤ top-10 –∏–∑–º–µ–Ω–∏–ª–∏—Å—å ‚Üí –∑–Ω–∞—á–∏–º–æ
  for (let i = 0; i < currentTopAmounts.length; i++) {
    if (currentTopAmounts[i] !== lastKnown.amounts[i]) {
      return true;
    }
  }

  // 5. –ï—Å–ª–∏ –ª—é–±–∞—è —Å—Ç–∞–≤–∫–∞ >= minimum –≤ top-10 ‚Üí –∑–Ω–∞—á–∏–º–æ
  for (const update of updates) {
    if (update.amount >= minTopAmount) {
      return true;
    }
  }

  return false; // –ù–µ –∑–Ω–∞—á–∏–º–æ
}
```

---

## üìä –§–æ—Ä–º–∞—Ç WebSocket —Å–æ–±—ã—Ç–∏–π

### –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç (fallback, –µ—Å–ª–∏ throttler –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω):
```json
{
  "auctionId": "abc123",
  "bid": {
    "id": "bid123",
    "userId": "user123",
    "amount": 500,
    "status": "ACTIVE"
  },
  "timestamp": "2026-01-10T20:00:00.000Z"
}
```

### –ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç (throttled, aggregated):
```json
{
  "auctionId": "abc123",
  "updatesCount": 150,  // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
  "topPositions": [
    {
      "position": 1,
      "userId": "user1",
      "amount": 1000
    },
    {
      "position": 2,
      "userId": "user2",
      "amount": 950
    },
    // ... –¥–æ 10 –ø–æ–∑–∏—Ü–∏–π
  ],
  "timestamp": "2026-01-10T20:00:00.000Z"
}
```

**Frontend –æ–±—Ä–∞–±–æ—Ç–∫–∞**: Frontend –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ–±–∞ —Ñ–æ—Ä–º–∞—Ç–∞, –ø—Ä–æ—Å—Ç–æ —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç refresh –∫–æ—Ç–æ—Ä—ã–π –∑–∞–≥—Ä—É–∂–∞–µ—Ç dashboard —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.

---

## üéØ –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –ü—Ä–∏ 10,000 —Å—Ç–∞–≤–æ–∫/—Å–µ–∫:
- **–ë–µ–∑ throttling**: 10,000 WebSocket emits/—Å–µ–∫
- **–° throttling**: ~1,000-3,000 emits/—Å–µ–∫ (70-90% —Å–Ω–∏–∂–µ–Ω–∏–µ)
- **–≠–∫–æ–Ω–æ–º–∏—è**: 7,000-9,000 emits/—Å–µ–∫

### –ü—Ä–∏ 100,000 —Å—Ç–∞–≤–æ–∫/—Å–µ–∫:
- **–ë–µ–∑ throttling**: 100,000 WebSocket emits/—Å–µ–∫ (–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å)
- **–° throttling**: ~10,000-30,000 emits/—Å–µ–∫ (70-90% —Å–Ω–∏–∂–µ–Ω–∏–µ)
- **–≠–∫–æ–Ω–æ–º–∏—è**: 70,000-90,000 emits/—Å–µ–∫ (–∫—Ä–∏—Ç–∏—á–Ω–æ –≤–∞–∂–Ω–æ!)

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
- ‚úÖ **CPU**: –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ 60-80%
- ‚úÖ **Network**: –°–Ω–∏–∂–µ–Ω–∏–µ —Ç—Ä–∞—Ñ–∏–∫–∞ –Ω–∞ 70-90%
- ‚úÖ **Client Performance**: –ö–ª–∏–µ–Ω—Ç—ã –ø–æ–ª—É—á–∞—é—Ç –º–µ–Ω—å—à–µ —Å–æ–æ–±—â–µ–Ω–∏–π, –±—Ä–∞—É–∑–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –±—ã—Å—Ç—Ä–µ–µ
- ‚úÖ **Scalability**: –°–∏—Å—Ç–µ–º–∞ –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –Ω–∞–º–Ω–æ–≥–æ –±–æ–ª—å—à–µ —Å—Ç–∞–≤–æ–∫ –Ω–∞ –æ–¥–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ

---

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (hardcoded, –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å configurable):
```typescript
BATCH_INTERVAL_MS = 100;        // –ò–Ω—Ç–µ—Ä–≤–∞–ª –±–∞—Ç—á–∏–Ω–≥–∞ (100ms)
TOP_POSITIONS_TO_TRACK = 10;    // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–∑–∏—Ü–∏–π –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è (top-10)
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:
```typescript
// –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É throttler
const stats = bidUpdateThrottler.getStats();
// {
//   pendingAuctions: 5,
//   totalPendingUpdates: 150,
//   cachedAuctionPositions: 5
// }
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Manual test:
1. –°–æ–∑–¥–∞—Ç—å –∞—É–∫—Ü–∏–æ–Ω —Å `totalGifts = 10`, `totalRounds = 3`
2. –†–∞–∑–º–µ—Å—Ç–∏—Ç—å 1000+ —Å—Ç–∞–≤–æ–∫ –∑–∞ –∫–æ—Ä–æ—Ç–∫–∏–π –ø–µ—Ä–∏–æ–¥ (10 —Å–µ–∫—É–Ω–¥)
3. –ù–∞–±–ª—é–¥–∞—Ç—å –ª–æ–≥–∏:
   - `Queued bid_update for auction...` (–¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç–∞–≤–∫–∏)
   - `Flushed X bid updates...` (–∫–∞–∂–¥—ã–µ 100ms, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–Ω–∞—á–∏–º–æ)
   - `Skipped X bid updates...` (–µ—Å–ª–∏ –Ω–µ –∑–Ω–∞—á–∏–º–æ)

### Expected behavior:
- –°—Ç–∞–≤–∫–∏ –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥–∏
- –ö–∞–∂–¥—ã–µ 100ms –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∑–Ω–∞—á–∏–º–æ—Å—Ç—å
- –≠–º–∏—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ top-10 –∏–∑–º–µ–Ω–∏–ª—Å—è
- Force flush –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Ä–∞—É–Ω–¥–∞

---

## üìù –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

### 1. Memory Management:
- Pending updates —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏ (Map<auctionId, Set<updates>>)
- –û—á–∏—â–∞—é—Ç—Å—è –ø–æ—Å–ª–µ flush –∏–ª–∏ force flush
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–æ –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∞—É–∫—Ü–∏–æ–Ω–∞–º–∏ (–æ–±—ã—á–Ω–æ 1-10 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ)

### 2. Error Handling:
- –ï—Å–ª–∏ `checkSignificance()` –ø–∞–¥–∞–µ—Ç ‚Üí emit –≤—Å–µ —Ä–∞–≤–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç (fallback)
- –ï—Å–ª–∏ `flushPendingUpdates()` –ø–∞–¥–∞–µ—Ç ‚Üí –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è, –Ω–æ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å–ª–µ–¥—É—é—â—É—é –∏—Ç–µ—Ä–∞—Ü–∏—é
- –ï—Å–ª–∏ `AuctionsGateway` –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω ‚Üí –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è warning, –Ω–æ –Ω–µ –ø–∞–¥–∞–µ—Ç

### 3. Fallback:
- –ï—Å–ª–∏ `ThrottlerService` –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è immediate emit (—Å—Ç–∞—Ä–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ)
- –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å frontend (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ–±–∞ —Ñ–æ—Ä–º–∞—Ç–∞)

### 4. Performance:
- `checkSignificance()` –¥–µ–ª–∞–µ—Ç 1 DB –∑–∞–ø—Ä–æ—Å –Ω–∞ –∞—É–∫—Ü–∏–æ–Ω (getTopActiveBids)
- –î–ª—è 10 –∞—É–∫—Ü–∏–æ–Ω–æ–≤ = 10 –∑–∞–ø—Ä–æ—Å–æ–≤ –∫–∞–∂–¥—ã–µ 100ms = 100 –∑–∞–ø—Ä–æ—Å–æ–≤/—Å–µ–∫ (–ø—Ä–∏–µ–º–ª–µ–º–æ)
- –ú–æ–∂–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º top-10 (–Ω–æ —ç—Ç–æ —É–∂–µ –¥—Ä—É–≥–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)

---

## üîÑ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

1. **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ top-10**:
   - –•—Ä–∞–Ω–∏—Ç—å top-10 –≤ –ø–∞–º—è—Ç–∏ (–æ–±–Ω–æ–≤–ª—è—Ç—å –ø—Ä–∏ –∫–∞–∂–¥–æ–º flush)
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–µ—à –¥–ª—è `checkSignificance()` –≤–º–µ—Å—Ç–æ DB –∑–∞–ø—Ä–æ—Å–∞
   - –û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç: –°–Ω–∏–∂–µ–Ω–∏–µ DB –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ 80-90%

2. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã**:
   - –í—ã–Ω–µ—Å—Ç–∏ `BATCH_INTERVAL_MS` –∏ `TOP_POSITIONS_TO_TRACK` –≤ config
   - –ü–æ–∑–≤–æ–ª–∏—Ç—å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –Ω–∞ —É—Ä–æ–≤–Ω–µ –∞—É–∫—Ü–∏–æ–Ω–∞

3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –º–µ—Ç—Ä–∏–∫–∏**:
   - Prometheus –º–µ—Ç—Ä–∏–∫–∏ (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ throttled emits, skipped emits)
   - Grafana dashboard –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏

4. **–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π throttling**:
   - –£–≤–µ–ª–∏—á–∏–≤–∞—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ
   - –£–º–µ–Ω—å—à–∞—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–∏ –Ω–∏–∑–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ

---

## ‚úÖ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**WebSocket Update Throttling —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω** –≤ —Å–∏—Å—Ç–µ–º—É. –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –≤–∞–∂–Ω–æ –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç–∏ –ø—Ä–∏ –≤—ã—Å–æ–∫–∏—Ö –Ω–∞–≥—Ä—É–∑–∫–∞—Ö (100k+ bids/round). –°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –Ω–∞–º–Ω–æ–≥–æ –±–æ–ª—å—à–µ —Å—Ç–∞–≤–æ–∫ –Ω–∞ –æ–¥–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ, —Å–Ω–∏–∂–∞—è –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ CPU, network –∏ –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–∞ 70-90%.
